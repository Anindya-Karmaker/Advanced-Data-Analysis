<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Analyzer BETA| McDonald-Nandi Lab</title>
    <meta name="description"
        content="Free browser-based tool to visualize and analyze chromatography and scientific data. Import CSV/Excel, smooth plots, detect peaks, and export high-quality figures.">
    <meta name="keywords"
        content="Data Analysis, Smoothing, Peak Detection, Savitzky-Golay, Plotting, Scientific Graphing, Anindya Karmaker">
    <meta name="author" content="Anindya Karmaker, McDonald-Nandi Lab">

    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ... existing styles ... */
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* App Header from Template */
        .app-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 60px;
            width: auto;
        }

        .app-title {
            font-size: 24px;
            color: #333;
            margin: 0;
            font-weight: 600;
        }

        .app-subtitle {
            font-size: 16px;
            color: #555;
            margin: 5px 0 0 0;
        }

        @media (min-width: 900px) {
            .app-header {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }
        }

        /* Main Grid from Template */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .main-grid>div:first-child {
            display: flex;
            flex-direction: column;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }

        .main-grid>div:last-child {
            min-width: 320px;
            max-width: 320px;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .main-grid>div:first-child {
                overflow-x: auto;
            }
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        #plotly-div {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        /* Controls */
        /* Controls Panel from Template */
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-group {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* Buttons */
        /* Buttons */
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            width: 100%;
            text-align: center;
        }

        .button-success {
            background: #00796b;
            color: white;
        }

        .button-success:hover {
            background: #004d40;
        }

        .button-secondary {
            background: #00796b;
            color: white;
        }

        .button-secondary:hover {
            background: #004d40;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .button-success:hover {
            background: #27ae60;
        }

        .button-secondary {
            background: #3498db;
            color: white;
        }

        .button-secondary:hover {
            background: #2980b9;
        }

        .button-danger {
            background: #e74c3c;
            color: white;
        }

        .button-danger:hover {
            background: #c0392b;
        }

        /* Lists/Inputs */
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .file-list li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .file-list li:hover {
            background: #f9f9f9;
        }

        .file-list li.active {
            background: #e8f6ff;
            border-left: 3px solid #3498db;
            font-weight: 600;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        select,
        input[type="text"],
        input[type="number"],
        input[type="color"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .small-input {
            padding: 4px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 8px;
            width: 800px;
            position: relative;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: black;
        }

        /* Stats Box */
        .stats-box {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            font-size: 12px;
            margin-top: 10px;
        }

        .peak-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }

        /* Footer */
        footer {
            text-align: center;
            color: #6c757d;
            margin-top: 40px;
            padding-top: 20px;
            font-size: 0.85rem;
            border-top: 1px solid #ddd;
        }

        footer p {
            margin-bottom: 0.5rem;
        }

        footer a {
            color: #00796b;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- App Header -->
        <div class="app-header">
            <div class="header-left">
                <div class="header-text">
                    <h1 class="app-title">Advanced Data Analyzer</h1>
                    <p class="app-subtitle">Interactive visualization and analysis of chromatography and scientific
                        data.</p>
                </div>
            </div>
            <div class="header-right">
                <img src="logo.png" alt="Lab Logo" class="header-logo">
            </div>
        </div>

        <div class="main-grid">
            <!-- Left Column: Chart -->
            <div>
                <div class="chart-container">
                    <div id="plotly-div" style="width:100%; height:100%; min-height: 600px;"></div>
                </div>

                <div class="status-bar" id="statusBar"
                    style="margin-top: 20px; padding: 10px; background: #e8f4f8; border-radius: 4px; color: #555; font-size: 13px;">
                    Ready.
                </div>

                <div style="margin-top: 20px;">
                    <button id="view-table-btn" class="button-secondary" style="width: auto;">
                        <i class="fa-solid fa-table"></i> View Data Table
                    </button>
                    <div id="table-container" style="display:none; margin-top: 15px; overflow-x: auto;">
                        <table id="data-table" style="width:100%; border-collapse: collapse; font-size: 13px;"></table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls -->
            <div class="controls-panel">

                <!-- 1. File Import & Session -->
                <div class="control-group">
                    <h3><i class="fa-solid fa-folder-open"></i> Data & Session</h3>
                    <button onclick="openCustomImportModal()" class="button-success" style="margin-bottom: 10px;">
                        <i class="fa-solid fa-file-import"></i> Import Files
                    </button>

                    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <button onclick="saveSession()" class="button-secondary" style="font-size: 13px;">
                            <i class="fa-solid fa-floppy-disk"></i> Save Session
                        </button>
                        <button onclick="document.getElementById('loadSessionInput').click()" class="button-secondary"
                            style="font-size: 13px;">
                            <i class="fa-solid fa-upload"></i> Load Session
                        </button>
                        <input type="file" id="loadSessionInput" accept=".json" style="display: none;"
                            onchange="loadSession(this)">
                    </div>

                    <div
                        style="padding: 10px; background: #f9f9f9; border: 1px solid #eee; border-radius: 4px; margin-bottom: 15px;">
                        <label style="font-size: 12px; font-weight: 600; margin-bottom: 8px; display: block;">Global
                            X-Axis Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>
                                <label style="font-size: 11px;">Start</label>
                                <input type="number" id="xAxisStart" class="small-input" placeholder="Min"
                                    onchange="updateGlobalXRange()">
                            </div>
                            <div>
                                <label style="font-size: 11px;">End</label>
                                <input type="number" id="xAxisEnd" class="small-input" placeholder="Max"
                                    onchange="updateGlobalXRange()">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label>Loaded Files:</label>
                        <ul id="file-list" class="file-list">
                            <li style="color: #999; font-style: italic; padding: 10px; text-align: center;">No files
                                loaded</li>
                        </ul>
                    </div>
                </div>

                <!-- 2. Plot Configuration -->
                <div class="control-group" id="config-panel" style="display:none;">
                    <h3><i class="fa-solid fa-gear"></i> Configuration</h3>

                    <div
                        style="margin-bottom: 15px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 4px;">
                        <label style="font-size: 11px; text-transform: uppercase;">Active File</label>
                        <strong id="active-file-name" style="color: #00796b;">-</strong>

                        <div style="margin-top: 10px;">
                            <label
                                style="font-size: 13px; font-weight: 600; display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="showTraceCheck" checked onchange="toggleTraceVisibility()"
                                    style="margin-right: 8px;">
                                Show Trace on Plot
                            </label>
                        </div>
                    </div>

                    <!-- Embedded Style Controls -->
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px;">Trace Style</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px;">Name</label>
                                <input type="text" id="styleTraceName" class="small-input" placeholder="Trace Name"
                                    onchange="applyStyleSettings()">
                            </div>
                            <div>
                                <label style="font-size: 12px;">Color</label>
                                <input type="color" id="styleColor" style="height: 30px; width: 100%; cursor:pointer;"
                                    onchange="applyStyleSettings()">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 12px;">Mode</label>
                                <select id="styleMode" class="small-input" onchange="applyStyleSettings()">
                                    <option value="lines">Lines</option>
                                    <option value="markers">Points</option>
                                    <option value="lines+markers">Both</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px;">Width</label>
                                <input type="number" id="styleLineWidth" value="2" min="1" max="20" class="small-input"
                                    onchange="applyStyleSettings()">
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <label style="font-size: 12px;">Dash</label>
                            <select id="styleLineDash" class="small-input" onchange="applyStyleSettings()">
                                <option value="solid">Solid</option>
                                <option value="dash">Dash</option>
                                <option value="dot">Dot</option>
                                <option value="dashdot">Dash-Dot</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="x-axis-select">X Column</label>
                        <select id="x-axis-select"></select>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="y-axis-select">Y Column</label>
                        <select id="y-axis-select"></select>
                    </div>

                    <!-- New: Axis Naming & Y2 Toggle -->
                    <div style="margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display:block;">Axis Settings</label>

                        <div style="margin-bottom: 8px;">
                            <label style="font-size: 11px;">X Axis Title</label>
                            <input type="text" id="xAxisLabel" class="small-input" placeholder="X Label">
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label style="font-size: 11px;">Y Axis Title</label>
                            <input type="text" id="yAxisLabel" class="small-input" placeholder="Y Label">
                        </div>

                        <div style="margin-top: 10px;">
                            <label style="font-size: 13px; font-weight: 600;">
                                <input type="checkbox" id="enableY2Check"> Enable Secondary Y-Axis
                            </label>
                        </div>
                        <div id="y2-settings" style="margin-top: 8px; margin-left: 20px; display:none;">
                            <label style="font-size: 11px;">Y2 Axis Title</label>
                            <input type="text" id="y2AxisLabel" class="small-input" placeholder="Y2 Label">
                        </div>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px;">Smoothing</label>

                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px;">Method</label>
                            <select id="smoothing-method" onchange="updateActiveSmoothing()">
                                <option value="movingAverage">Moving Average</option>
                                <option value="savitzkyGolay">Savitzky-Golay</option>
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="smoothing-slider" min="0" max="400" value="0" style="flex: 1;"
                                step="1">
                            <span id="smoothing-value" style="width: 30px; text-align: right; font-size: 12px;">0</span>
                        </div>
                        <p style="font-size: 11px; color: #666; margin-top: 2px;">Window Size (points)</p>

                        <!-- Modification: Peak Detection Slider -->
                        <div style="margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <label style="font-weight: 600; font-size: 12px;">Peak Detection (Min Height)</label>
                                <span id="peak-height-val" style="font-size: 11px; color: #555;">0.0</span>
                            </div>
                            <input type="range" id="peakHeightSlider" min="0" max="100" step="1" value="0"
                                style="width: 100%;">
                        </div>

                        <div id="sg-poly-options" style="display:none; margin-top: 10px;">
                            <label style="font-size: 12px;">Polynomial Order</label>
                            <input type="number" id="sg-poly-order" value="2" min="1" max="6"
                                onchange="updateActiveSmoothing()">
                        </div>
                    </div>

                    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px;">Trendline Fit</label>
                        <select id="trendline-type">
                            <option value="none">None</option>
                            <option value="linear">Linear (y=mx+b)</option>
                            <option value="polynomial">Polynomial (Order 2)</option>
                            <option value="power">Power (y=ax^b)</option>
                            <option value="exponential">Exponential (y=ae^bx)</option>
                            <option value="logarithmic">Logarithmic (y=a+bln(x))</option>
                        </select>
                        <div id="trendline-stats" class="stats-box" style="display:none; margin-top: 10px;"></div>
                    </div>

                    <div style="display: flex; gap: 5px; margin-top: 20px;">
                        <button id="update-plot-btn" class="button-secondary"><i class="fa-solid fa-rotate"></i>
                            Update</button>
                        <button id="remove-file-btn" class="button-danger"><i class="fa-solid fa-trash"></i>
                            Remove</button>
                    </div>
                </div>

                <!-- 3. Export -->
                <div class="control-group">
                    <h3><i class="fa-solid fa-download"></i> Export</h3>
                    <button
                        onclick="Plotly.downloadImage('plotly-div', {format: 'png', width: 1200, height: 800, filename: 'plot'})">
                        <i class="fa-solid fa-image"></i> Save Plot as PNG
                    </button>
                    <button onclick="copyPlotToClipboard()" style="margin-top: 8px;">
                        <i class="fa-solid fa-copy"></i> Copy Plot to Clipboard
                    </button>

                    <hr style="margin: 15px 0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;"><i class="fa-solid fa-tags"></i> Custom Labels</h3>
                        <label
                            style="font-size: 13px; font-weight: 600; display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="showLabelsCheck" checked onchange="toggleAllLabels()"
                                style="margin-right: 6px;">
                            Show Labels
                        </label>
                    </div>
                    <button id="toggleLabelBtn" onclick="toggleLabelMode()" class="button-secondary">
                        üè∑Ô∏è Add Custom Labels
                    </button>
                    <button onclick="openLabelManager()" class="button-secondary" style="margin-top: 8px;">
                        üìã Manage Labels
                    </button>
                    <button onclick="clearLabels()" class="button-danger" style="margin-top: 8px;">
                        ‚úñ Clear All Labels
                    </button>
                    <p style="font-size: 11px; color: #666; margin-top: 8px;">Click on the plot to add labels for
                        publication.</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Custom Import Modal -->
    <div id="customImportModal" class="modal"
        style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
        <div class="modal-content"
            style="background-color: white; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 800px; position:relative;">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Import Files</h2>
                <span class="close" onclick="closeCustomImportModal()"
                    style="font-size: 28px; cursor: pointer;">&times;</span>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label>Select File:</label>
                <div style="display:flex; gap:10px;">
                    <input type="file" id="customFileInput" accept=".csv,.txt,.xlsx,.xls">
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label>Delimiter (for CSV/Text):</label>
                <select id="previewDelimiter">
                    <option value="auto">Auto-Detect</option>
                    <option value=",">Comma (,)</option>
                    <option value="\t">Tab</option>
                    <option value=";">Semicolon (;)</option>
                    <option value=" ">Space</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label>Header Row (0 for no header):</label>
                <input type="number" id="headerRowIndex" value="1" min="0" style="width: 80px;">
                <span style="font-size: 12px; color: #666; margin-left: 10px;">(0 = No Header, 1 = First Row)</span>
            </div>

            <button onclick="previewCustomFile()" class="button-secondary" style="width: auto; margin-bottom: 15px;">
                <i class="fa-solid fa-eye"></i> Preview Data
            </button>

            <div id="preview-section" style="display:none;">
                <div class="table-container"
                    style="max-height: 250px; overflow: auto; border: 1px solid #ddd; margin-bottom: 20px;">
                    <table id="previewTable" style="width:100%; border-collapse: collapse; font-size: 12px;"></table>
                </div>

                <div id="columnMappingSection"
                    style="background: #f9f9f9; padding: 15px; border-radius: 4px; border: 1px solid #eee;">
                    <h3 style="font-size:14px; margin-bottom:10px;">Initial Column Mapping</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>X Axis Column:</label>
                            <select id="mapXSelect"></select>
                            <input type="text" id="mapXLabel" placeholder="Custom X Label"
                                style="margin-top: 5px; width: 100%;">
                        </div>
                        <div>
                            <label>Y Axis Column:</label>
                            <select id="mapYSelect"></select>
                            <input type="text" id="mapYLabel" placeholder="Custom Y Label"
                                style="margin-top: 5px; width: 100%;">
                        </div>
                        <!-- Y2 Axis Support -->
                        <div>
                            <label>Y2 Axis (Optional):</label>
                            <select id="mapY2Select">
                                <option value="">(None)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="importFullFile()" class="button-success" id="importBtn" disabled>
                        <i class="fa-solid fa-check"></i> Import Full File
                    </button>
                    <button onclick="closeCustomImportModal()" class="button-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>
            <strong>Developed by:</strong> Anindya Karmaker, PhD Candidate, McDonald-Nandi Lab.
        </p>
        <p>
            <strong>Source Code:</strong>
            <a href="https://github.com/Anindya-Karmaker/Chromatogram-Plotter-Analyzer" target="_blank"
                rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"
                    style="vertical-align: text-bottom; margin-right: 4px;">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                </svg>
                View on GitHub
            </a>
        </p>
        <p>
            <strong>Funding:</strong> The development of this tool was supported by the National Science Foundation
            Partnerships for Innovation (PFI) program under Grant No. 2016563.
        </p>
    </footer>

    <script src="script.js"></script>
</body>

</html>
